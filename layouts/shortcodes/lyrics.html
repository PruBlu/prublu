{{/* usage:  {{< lyrics id="vituiks_man" >}}  -> data/lyrics/vituiks_man.yml */}}
{{ $id := .Get "id" | lower }}
{{ $song := index site.Data.lyrics $id }}

{{ if not $song }}
  <p style="color:#b91c1c">Data unfound: data/lyrics/{{ $id }}.yml</p>
{{ else }}

{{/* 列顺序 & 映射：code -> []lines */}}
{{ $cols := slice }}
{{ $linesMap := dict }}
{{ range $v := $song.language_versions }}
  {{ $cols = $cols | append $v.lang_code }}
  {{ $linesMap = merge $linesMap (dict $v.lang_code $v.lyrics) }}
{{ end }}

{{/* 最大行数 */}}
{{ $max := 0 }}
{{ range $code := $cols }}
  {{ $l := index $linesMap $code | default (slice) }}
  {{ if gt (len $l) $max }}{{ $max = len $l }}{{ end }}
{{ end }}

<div class="tri-lyrics" id="top">
  <h2 class="tri-title">{{ $song.title }}</h2>
  <p class="tri-meta"><strong>{{ $song.artist }}</strong> — {{ $song.album }}</p>

  <div class="tri-table-wrap">
    <table class="tri-table">
      <thead>
        <tr>
          {{ range $code := $cols }}<th>{{ $code }}</th>{{ end }}
        </tr>
      </thead>
      <tbody>
        {{ range $i, $_ := seq $max }}
          <tr>
            {{ range $code := $cols }}
              {{ $arr := index $linesMap $code | default (slice) }}
              {{ $line := cond (lt $i (len $arr)) (index $arr $i) "" }}

              {{/* 把 [数字] 变成链接到 #note-数字；避免影响 [?] */}}
              {{ $linked := cond (ne $line "") (replaceRE `\[(\d+)\]` `<a class="fn" href="#note-$1">[$1]</a>` $line) "" }}

              <td><span class="line">{{ $linked | safeHTML }}</span></td>
            {{ end }}
          </tr>
        {{ end }}
      </tbody>
    </table>
  </div>

  {{ with $song.notes }}
  <div class="tri-notes">
    <h3>Notes</h3>
    <ol>
      {{ range . }}
        <li id="note-{{ .id }}">
          <span class="note-num">[{{ .id }}]</span>
          {{ .text }}
          <a class="backref" href="#top" aria-label="Back to top">↩︎</a>
        </li>
      {{ end }}
    </ol>
  </div>
  {{ end }}
</div>

<style>
/* —— 外观（与之前一致） —— */
.tri-table-wrap{overflow:auto;border-radius:.5rem}
.tri-table{width:100%;border-collapse:separate;border-spacing:0}
.tri-table th,.tri-table td{border:0;padding:.6rem .8rem;vertical-align:top;line-height:1.6}
.tri-table thead th{font-weight:600;opacity:.85;position:sticky;top:0;background:var(--tri-bg,#fff)}
.tri-table tbody tr:hover td{background:var(--tri-hover,rgba(255,224,130,.35))}
.tri-table tbody td:hover{background:var(--tri-active,rgba(255,224,130,.6))}
.tri-title{margin:.2rem 0 .3rem}
.tri-meta{margin:0 0 .6rem;opacity:.8}

/* —— 脚注样式 —— */
.fn{ text-decoration: underline; font-size:.95em }
.tri-notes{margin-top:1.5rem;padding:.8rem 1rem;border-left:3px solid #ccc;font-size:.95em;line-height:1.5}
.tri-notes h3{margin:.2rem 0 .6rem;font-size:1.1em;font-weight:600}
.tri-notes ol{margin:0;padding-left:1.4rem}
.tri-notes li{margin:.4rem 0}
.tri-notes .note-num{font-weight:600;margin-right:.25rem}
.tri-notes .backref{margin-left:.4rem;text-decoration:none;opacity:.7}
.tri-notes .backref:hover{opacity:1}

@media (prefers-color-scheme: dark){
  :root{ --tri-bg:#0b0b0b; --tri-hover:rgba(255,255,255,.08); --tri-active:rgba(255,255,255,.14) }
  .tri-notes{border-color:#555}
}
</style>
{{ end }}
