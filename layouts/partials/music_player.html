
{{- $url := "" -}}
{{- $height := 0 -}}

{{- with .Params.music -}}
  {{- $m := . -}}
  {{- if reflect.IsMap $m -}}
    {{- $url = index $m "url" -}}
    {{- with index $m "height" }}{{ $height = . }}{{ end -}}
  {{- else -}} 
    {{- $url = $m -}}
  {{- end -}}
{{- end -}}


{{- if $url -}}
  {{- $src := "" -}}
  {{- $h := 0 -}}

  {{- if or (in $url "open.spotify.com/track/") (in $url "open.spotify.com/album/") (in $url "open.spotify.com/playlist/") -}}
    {{- $clean := replaceRE `open\.spotify\.com/(?:intl-[a-z-]+/)?` `open.spotify.com/` $url -}}
    {{- $src = replaceRE `^https?://open\.spotify\.com/` `https://open.spotify.com/embed/` $clean -}}
    {{- if in $src "/embed/track/" -}}
      {{- $h = 152 -}}
    {{- else -}}
      {{- $h = 352 -}}
    {{- end -}}
  {{- end -}}

  {{- if or (in $url "music.163.com/#/song") (in $url "music.163.com/#/playlist") (in $url "music.163.com/#/album") (in $url "y.music.163.com/m/") -}}
    {{- $id := replaceRE `.*id=(\d+).*` `$1` $url -}}
    {{- $t := 2 -}} {{/* 2=music, 0=playlist, 1=album */}}
    {{- if in $url "/playlist" -}}{{- $t = 0 -}}{{- end -}}
    {{- if in $url "/album" -}}{{- $t = 1 -}}{{- end -}}
    {{- $src = printf "https://music.163.com/outchain/player?type=%d&id=%s&auto=0&height=%d" $t $id (cond (gt $height 0) $height (cond (eq $t 2) 66 450)) -}}
    {{- $h = cond (gt $height 0) $height (cond (eq $t 2) 86 480) -}}
  {{- end -}}

  {{- if $src -}}
    <div class="music-embed">
      <iframe
        style="border:0; width:100%; height:{{ $height | default $h }}px; border-radius:12px"
        loading="lazy"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        allowfullscreen
        src="{{ $src }}">
      </iframe>
    </div>
    <style>
      .music-embed{margin:0 0 1rem;overflow:hidden}
      @media (prefers-color-scheme: dark){
        .music-embed iframe{background:#181818}
      }
    </style>
  {{- else -}}
  {{- end -}}
{{- end -}}
