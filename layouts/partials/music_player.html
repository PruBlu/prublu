{{- $musicURL := "" -}}{{- $musicH := 0 -}}
{{- with .Params.music -}}
  {{- $m := . -}}
  {{- if reflect.IsMap $m -}}
    {{- $musicURL = index $m "url" -}}
    {{- with index $m "height" }}{{ $musicH = . }}{{ end -}}
  {{- else -}}
    {{- $musicURL = $m -}}
  {{- end -}}
{{- end -}}

{{- $ytURL := "" -}}{{- $ytH := 0 -}}{{- $ytStart := 0 -}}
{{- with .Params.youtube -}}
  {{- $y := . -}}
  {{- if reflect.IsMap $y -}}
    {{- $ytURL = index $y "url" -}}
    {{- with index $y "height" }}{{ $ytH = . }}{{ end -}}
    {{- with index $y "start" }}{{ $ytStart = . }}{{ end -}}
  {{- else -}}
    {{- $ytURL = $y -}}
  {{- end -}}
{{- end -}}


{{- $musicSrc := "" -}}{{- $musicAutoH := 0 -}}
{{- if $musicURL -}}
  {{- /* Spotify */ -}}
  {{- if or (in $musicURL "open.spotify.com/track/") (in $musicURL "open.spotify.com/album/") (in $musicURL "open.spotify.com/playlist/") -}}
    {{- $clean := replaceRE `open\.spotify\.com/(?:intl-[a-z-]+/)?` `open.spotify.com/` $musicURL -}}
    {{- $musicSrc = replaceRE `^https?://open\.spotify\.com/` `https://open.spotify.com/embed/` $clean -}}
    {{- if in $musicSrc "/embed/track/" -}}{{- $musicAutoH = 152 -}}{{- else -}}{{- $musicAutoH = 352 -}}{{- end -}}
  {{- end -}}
  
  {{- if or (in $musicURL "music.163.com/#/song") (in $musicURL "music.163.com/#/playlist") (in $musicURL "music.163.com/#/album") (in $musicURL "y.music.163.com/m/") -}}
    {{- $id := replaceRE `.*id=(\d+).*` `$1` $musicURL -}}
    {{- $t := 2 -}} {{/* 2=music, 0=playlist, 1=album */}}
    {{- if in $musicURL "/playlist" -}}{{- $t = 0 -}}{{- end -}}
    {{- if in $musicURL "/album" -}}{{- $t = 1 -}}{{- end -}}
    {{- $musicSrc = printf "https://music.163.com/outchain/player?type=%d&id=%s&auto=0&height=%d" $t $id (cond (gt $musicH 0) $musicH (cond (eq $t 2) 66 450)) -}}
    {{- $musicAutoH = cond (gt $musicH 0) $musicH (cond (eq $t 2) 86 480) -}}
  {{- end -}}
{{- end -}}

{{- $ytSrc := "" -}}{{- $ytAutoH := 0 -}}
{{- if $ytURL -}}
  {{- /* 支持 youtu.be/ID, youtube.com/watch?v=ID, /shorts/ID, /embed/ID */ -}}
  {{- $id := replaceRE `.*(?:youtu\.be/|youtube\.com/(?:watch\?v=|shorts/|embed/))([A-Za-z0-9_-]{11}).*` `$1` $ytURL -}}
  {{- if $id -}}
    {{- $qs := slice "rel=0" -}}
    {{- if gt $ytStart 0 -}}
      {{- $qs = $qs | append (printf "start=%d" $ytStart) -}}
    {{- end -}}
    {{- $ytSrc = printf "https://www.youtube-nocookie.com/embed/%s?%s" $id (delimit $qs "&") -}}
    {{- $ytAutoH = cond (gt $ytH 0) $ytH 315 -}} 
  {{- end -}}
{{- end -}}

{{- if or $musicSrc $ytSrc -}}
  <div class="players">
    {{- if $musicSrc -}}
      <div class="player-block">
        <iframe
          style="border:0; width:100%; height:{{ $musicH | default $musicAutoH }}px; border-radius:12px"
          loading="lazy"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture; accelerometer; gyroscope"
          allowfullscreen
          src="{{ $musicSrc }}">
        </iframe>
        <div class="music-actions">
            <a class="music-open" href="{{ $musicURL }}" target="_blank" rel="noopener">
                Open
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
            </a>
        </div>

      </div>
    {{- end -}}

    {{- if $ytSrc -}}
      <div class="player-block">
        <iframe
          style="border:0; width:100%; height:{{ $ytH | default $ytAutoH }}px; border-radius:12px"
          loading="lazy"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
          allowfullscreen
          src="{{ $ytSrc }}">
        </iframe>
      </div>
    {{- end -}}
  </div>

  <style>
    .players{margin:0 0 1rem;display:grid;gap:1rem}
    .player-block{}
    .music-actions{margin:.5rem 0 1rem}
    .music-open {
        text-decoration: underline;
        color: inherit;
        display: inline-flex;
        align-items: center;
        gap: 0.3em;
    }
    .music-open svg {
        flex-shrink: 0;
    }

  </style>
{{- end -}}
